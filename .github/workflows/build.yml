name: Build SoloMiner App

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  check-build-needed:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is every 4th commit
        id: check
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "Total commits on main: $COMMIT_COUNT"
          REMAINDER=$((COMMIT_COUNT % 4))
          echo "Remainder: $REMAINDER"
          if [ "$REMAINDER" -eq "0" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "BUILD TRIGGERED - commit #$COMMIT_COUNT is divisible by 4"
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "Skipping build - $((4 - REMAINDER)) more commit(s) until next build"
          fi

  build:
    needs: check-build-needed
    if: needs.check-build-needed.outputs.should_build == 'true'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependancies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Verify imports work
        run: |
          python -c "from solominer.config import APP_VERSION; print(f'SoloMiner v{APP_VERSION}')"
          python -c "from solominer.metal_miner import MetalMiner, create_miner; print('metal_miner OK')"
          python -c "from solominer.engine import MiningEngine; print('engine OK')"

      - name: Build .app with PyInstaller
        run: |
          pyinstaller SoloMiner.spec
          ls -la dist/
          ls -la dist/SoloMiner.app/Contents/ || true

      - name: Verify app bundle
        run: |
          test -d dist/SoloMiner.app || (echo "App bundle not found!" && exit 1)
          plutil -p dist/SoloMiner.app/Contents/Info.plist
          echo "App bundle size:"
          du -sh dist/SoloMiner.app

      - name: Zip app bundle
        run: |
          cd dist
          zip -r -y SoloMiner-macos.zip SoloMiner.app
          ls -lh SoloMiner-macos.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SoloMiner-macos
          path: dist/SoloMiner-macos.zip
          retention-days: 30

      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "from solominer.config import APP_VERSION; print(APP_VERSION)")
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}-build${COMMIT_COUNT}" >> "$GITHUB_OUTPUT"
          echo "name=SoloMiner v${VERSION} (build #${COMMIT_COUNT})" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.name }}
          body: |
            <p align="center">
              <img src="https://raw.githubusercontent.com/CooperWaNg-py/SoloMiner/main/logo.png" width="96" alt="SoloMiner">
            </p>

            <p align="center">
              <strong>Solo Bitcoin mining from your macOS menu bar.</strong><br>
              Metal GPU accelerated SHA-256d | Stratum v1 | Native macOS
            </p>

            ---

            ## Install

            1. Download **SoloMiner-macos.zip** below
            2. Extract the zip to get `SoloMiner.app`
            3. Drag it to your **Applications** folder (or run from anywhere)

            ## macOS Privacy & Security

            This app is not signed with an Apple Developer certificate, so macOS Gatekeeper will block it on first launch. This is normal for open-source apps distributed outside the App Store.

            **To open it:**

            1. Double-click `SoloMiner.app` -- macOS will show *"SoloMiner can't be opened because Apple cannot check it for malicious software"*
            2. Open **System Settings** > **Privacy & Security**
            3. Scroll down -- you will see *"SoloMiner was blocked from use because it is not from an identified developer"*
            4. Click **Open Anyway**
            5. In the confirmation dialog, click **Open**

            You only need to do this once. After that it opens normally.

            > **Alternative:** Right-click the app > **Open** > click **Open** in the dialog to bypass Gatekeeper directly.

            ---

            Built from commit `${{ github.sha }}` on macOS 14 with Python 3.12.
          files: dist/SoloMiner-macos.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
